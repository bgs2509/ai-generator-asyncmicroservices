name: CI Pipeline

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Continuous Integration Pipeline
# Runs on every push and pull request
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.12'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CODE QUALITY CHECKS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-
            ${{ runner.os }}-pip-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit

      - name: Run Ruff (linter + formatter check)
        run: |
          echo "::group::Ruff Linting"
          ruff check services/ shared/ --output-format=github
          echo "::endgroup::"

          echo "::group::Ruff Format Check"
          ruff format --check services/ shared/
          echo "::endgroup::"

      - name: Run Mypy (type checking)
        run: |
          echo "::group::Mypy Type Checking"
          mypy --config-file pyproject.toml services/ shared/ || true
          echo "::endgroup::"

      - name: Run Bandit (security)
        run: |
          echo "::group::Bandit Security Check"
          bandit -r services/ shared/ -ll -f json -o bandit-report.json || true
          bandit -r services/ shared/ -ll
          echo "::endgroup::"

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: bandit-security-report
          path: bandit-report.json

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # UNIT TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - template_business_api
          - template_business_bot
          - template_business_worker
          - template_data_postgres_api
          - template_data_mongo_api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.service }}-${{ hashFiles(format('services/{0}/requirements.txt', matrix.service)) }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.service }}-
            ${{ runner.os }}-pip-

      - name: Install service dependencies
        run: |
          cd services/${{ matrix.service }}
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock

      - name: Run unit tests
        run: |
          cd services/${{ matrix.service }}
          if [ -d "tests/unit" ]; then
            pytest tests/unit/ -v --tb=short --cov=src --cov-report=xml --cov-report=term
          else
            echo "No unit tests found for ${{ matrix.service }}"
          fi

      - name: Upload coverage to Codecov
        if: matrix.service == 'template_business_api'
        uses: codecov/codecov-action@v3
        with:
          files: ./services/${{ matrix.service }}/coverage.xml
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # INTEGRATION TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      mongodb:
        image: mongo:7
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: admin
          RABBITMQ_DEFAULT_PASS: admin
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5672:5672

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install all service dependencies
          for service in services/*; do
            if [ -f "$service/requirements.txt" ]; then
              pip install -r $service/requirements.txt
            fi
          done
          pip install pytest pytest-asyncio testcontainers

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/test_db
          MONGO_URL: mongodb://localhost:27017
          REDIS_URL: redis://localhost:6379/0
          RABBITMQ_URL: amqp://admin:admin@localhost:5672/
        run: |
          for service in services/*; do
            if [ -d "$service/tests/integration" ]; then
              echo "Running integration tests for $service"
              cd $service && pytest tests/integration/ -v --tb=short && cd ../..
            fi
          done

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD DOCKER IMAGES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test-unit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build services
        run: |
          docker-compose build
          docker-compose config --services

      - name: Test docker-compose up
        run: |
          docker-compose up -d
          sleep 30
          docker-compose ps
          docker-compose logs
          docker-compose down -v

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DRY/KISS/YAGNI PRINCIPLE ENFORCEMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  check-duplication:
    name: Check Code Duplication (DRY)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install jscpd
        run: npm install -g jscpd

      - name: Check for code duplication
        run: |
          echo "::group::DRY Principle Check"
          echo "Checking code duplication (threshold: 10%)"
          echo "==========================================="

          # Run jscpd on services and shared directories
          jscpd services/ shared/ \
            --threshold 10 \
            --format "python" \
            --reporters "console,html,json" \
            --output "./jscpd-report" \
            --exitCode 1 || {
              echo ""
              echo "âŒ DRY VIOLATION: Code duplication exceeds 10% threshold"
              echo ""
              echo "ğŸ“Š Duplicated code violates the DRY (Don't Repeat Yourself) principle."
              echo ""
              echo "ğŸ’¡ Consider extracting shared code to:"
              echo "   â€¢ shared/utils/ for reusable utilities"
              echo "   â€¢ Base classes for common patterns"
              echo "   â€¢ Helper functions in appropriate modules"
              echo ""
              echo "ğŸ“– Learn more: docs/guides/dry-kiss-yagni-principles.md#dry"
              echo "ğŸ“ Detailed report: jscpd-report/jscpd-report.html"
              echo ""
              exit 1
            }

          echo "âœ… DRY check passed: Code duplication is below 10%"
          echo "::endgroup::"

      - name: Upload duplication report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: jscpd-duplication-report
          path: ./jscpd-report

  check-complexity:
    name: Check Code Complexity (KISS)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install radon
        run: pip install radon

      - name: Check cyclomatic complexity
        run: |
          echo "::group::KISS Principle Check - Cyclomatic Complexity"
          echo "Checking cyclomatic complexity (threshold: McCabe < 10)"
          echo "========================================================="

          radon cc services/ shared/ --min B --total-average --show-complexity || {
            echo ""
            echo "âŒ KISS VIOLATION: Functions with complexity >= 10 detected"
            echo ""
            echo "ğŸ” Complex functions violate the KISS (Keep It Simple) principle."
            echo ""
            echo "ğŸ’¡ Consider refactoring by:"
            echo "   â€¢ Breaking large functions into smaller ones"
            echo "   â€¢ Extracting conditional logic into separate functions"
            echo "   â€¢ Using early returns to reduce nesting"
            echo "   â€¢ Applying strategy pattern for complex conditionals"
            echo ""
            echo "ğŸ“– Learn more: docs/guides/dry-kiss-yagni-principles.md#kiss"
            echo ""
            exit 1
          }

          echo "âœ… Complexity check passed: All functions have McCabe < 10"
          echo "::endgroup::"

      - name: Check maintainability index
        run: |
          echo "::group::KISS Principle Check - Maintainability Index"
          echo "Checking maintainability index (threshold: Grade B+)"
          echo "===================================================="

          radon mi services/ shared/ --min B --show || {
            echo ""
            echo "âŒ KISS VIOLATION: Low maintainability index detected"
            echo ""
            echo "ğŸ“Š Low maintainability indicates overly complex code."
            echo ""
            echo "ğŸ” Maintainability Index considers:"
            echo "   â€¢ Cyclomatic complexity"
            echo "   â€¢ Lines of code"
            echo "   â€¢ Halstead volume"
            echo "   â€¢ Comment density"
            echo ""
            echo "ğŸ’¡ Improve by:"
            echo "   â€¢ Simplifying complex functions"
            echo "   â€¢ Adding clear documentation"
            echo "   â€¢ Breaking down large modules"
            echo ""
            echo "ğŸ“– Learn more: docs/guides/dry-kiss-yagni-principles.md#kiss"
            echo ""
            exit 1
          }

          echo "âœ… Maintainability check passed: All modules have Grade B or better"
          echo "::endgroup::"

      - name: Check file sizes
        run: |
          echo "::group::KISS Principle Check - File Size"
          echo "Checking file sizes (threshold: 500 lines)"
          echo "==========================================="

          large_files=$(find services/ shared/ -name "*.py" -type f -exec wc -l {} \; | awk '$1 > 500 {print $2, "("$1" lines)"}')

          if [ -n "$large_files" ]; then
            echo ""
            echo "âŒ KISS VIOLATION: Files exceeding 500 lines detected"
            echo ""
            echo "$large_files"
            echo ""
            echo "ğŸ“ Large files are harder to understand and maintain."
            echo ""
            echo "ğŸ’¡ Consider splitting into:"
            echo "   â€¢ Multiple focused modules"
            echo "   â€¢ Separate classes with single responsibilities"
            echo "   â€¢ Service layer + repository layer"
            echo ""
            echo "ğŸ“– Learn more: docs/guides/dry-kiss-yagni-principles.md#kiss"
            echo ""
            exit 1
          fi

          echo "âœ… File size check passed: All files are under 500 lines"
          echo "::endgroup::"

  check-dependencies:
    name: Check Dependency Bloat (YAGNI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check dependency count per service
        run: |
          echo "::group::YAGNI Principle Check - Dependency Count"
          echo "Checking dependency count (threshold: 30 for Level 1-2, 50 for Level 3-4)"
          echo "============================================================================"

          failed_services=""

          for service in services/*/; do
            if [ -f "$service/requirements.txt" ]; then
              service_name=$(basename "$service")
              dep_count=$(grep -v '^#' "$service/requirements.txt" | grep -v '^$' | wc -l)

              # Default threshold for most services
              threshold=30

              # Higher threshold for business services (they have more integrations)
              if [[ "$service_name" == *"business"* ]]; then
                threshold=50
              fi

              echo "ğŸ“¦ $service_name: $dep_count dependencies (threshold: $threshold)"

              if [ $dep_count -gt $threshold ]; then
                echo "   âŒ EXCEEDS THRESHOLD"
                failed_services="$failed_services\n  â€¢ $service_name: $dep_count > $threshold"
              else
                echo "   âœ… OK"
              fi
            fi
          done

          if [ -n "$failed_services" ]; then
            echo ""
            echo "âŒ YAGNI VIOLATION: Too many dependencies in some services"
            echo ""
            echo "Failed services:"
            echo -e "$failed_services"
            echo ""
            echo "ğŸ“¦ Excessive dependencies indicate:"
            echo "   â€¢ Features that aren't needed yet (YAGNI)"
            echo "   â€¢ Increased attack surface"
            echo "   â€¢ Slower installation and docker builds"
            echo ""
            echo "ğŸ’¡ Review each dependency:"
            echo "   â€¢ Is it required for current maturity level?"
            echo "   â€¢ Can we use stdlib instead?"
            echo "   â€¢ Are there unused dependencies?"
            echo ""
            echo "ğŸ“– Learn more: docs/guides/dry-kiss-yagni-principles.md#yagni"
            echo ""
            exit 1
          fi

          echo ""
          echo "âœ… Dependency check passed: All services within limits"
          echo "::endgroup::"

      - name: Check for unused dependencies
        run: |
          echo "::group::YAGNI Principle Check - Unused Dependencies"
          echo "Detecting potentially unused dependencies"
          echo "========================================"

          pip install pip-autoremove 2>/dev/null || true

          echo "ğŸ’¡ To check for unused dependencies locally, run:"
          echo "   pip install pip-check"
          echo "   pip-check --verbose"
          echo ""
          echo "â„¹ï¸  This is an informational check (does not fail build)"
          echo "::endgroup::"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECURITY SCANNING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-integration, build, check-duplication, check-complexity, check-dependencies, security]
    if: success()

    steps:
      - name: Success notification
        run: |
          echo "âœ… All CI checks passed successfully!"
          echo ""
          echo "ğŸ“‹ Quality Gates Summary:"
          echo "   âœ… Linting & Type Checking"
          echo "   âœ… Unit Tests"
          echo "   âœ… Integration Tests"
          echo "   âœ… Docker Build"
          echo "   âœ… DRY Check (Code Duplication <10%)"
          echo "   âœ… KISS Check (Complexity, Maintainability, File Size)"
          echo "   âœ… YAGNI Check (Dependency Count)"
          echo "   âœ… Security Scanning"
          echo ""
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ‰ Ready for deployment!"
